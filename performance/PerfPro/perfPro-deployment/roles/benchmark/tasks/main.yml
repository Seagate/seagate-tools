---
#yum and pip installation are part of prepare_setup.yml

 - include: hostconfig.yml

 - include: prepare_setup.yml

 - name: Compressing directory files/PerfProBenchmark into files/PerfProBenchmark.tar.gz
   archive:
     path: "{{ role_path }}/files/PerfProBenchmark"
     dest: "{{ role_path }}/files/PerfProBenchmark.tar.gz"

 - name: Copying and Unarchieving PerfProBenchmark tar file
   unarchive:
     src: files/PerfProBenchmark.tar.gz
     dest: /root/
   delegate_to: "{{ item }}"
   with_items: "{{ groups['all'] }}"

 - name: copying config.yml file 
   copy:
     src: roles/perfpro_deployment/vars/config.yml
     dest: /root/PerfProBenchmark/
     owner: root
     group: root
     mode: '0644' 
   delegate_to: "{{ item }}"
   with_items: "{{ groups['all'] }}"
 
 - name: copying s3account.yml file 
   copy:
      src: vars/s3account.yml
      dest: /root/PerfProBenchmark/
      owner: root
      group: root
      mode: '0644' 
   delegate_to: "{{ item }}"
   with_items: "{{ groups['all'] }}"

 - name: copying main.yml file 
   copy:
     src: vars/main.yml
     dest: /root/PerfProBenchmark/
     owner: root
     group: root
     mode: '0644'
   delegate_to: "{{ item }}"
   with_items: "{{ groups['all'] }}"

 - name: Create S3 account
   command: python3 /root/PerfProBenchmark/S3UserCreation/main_createusers.py /root/PerfProBenchmark/s3account.yml 
   delegate_to: "{{ item }}"
   with_items: "{{ groups['clients'] }}"

 - name: Configuration of s3bench benchmark tools  
   command: go get github.com/igneous-systems/s3bench
   delegate_to: "{{ item }}"
   with_items: "{{ groups['clients'] }}"

 - name: copying s3bench_meta binaries file to client server
   copy:
       src: files/s3bench_meta
       dest: /root/go/bin/
       owner: root
       group: root
       mode: '0754'
   delegate_to: "{{ item }}"
   with_items: "{{ groups['clients'] }}"

 - include: finish_setup.yml

 - name: Make an entry for config.yml on a database
   command: python3 /root/PerfProBenchmark/addconfiguration.py '/root/PerfProBenchmark/main.yml' '/root/PerfProBenchmark/config.yml'
   delegate_to: "{{ item }}"
   with_items: "{{ groups['clients'] }}"

 - name: Read build from RELEASE.INFO file
   shell: python3 /root/PerfProBenchmark/read_build.py /root/PerfProBenchmark/config.yml
   register: build

 - name: Create perfpro_build<build> directory structure 
   shell: |
     rm -rf /root/PerfProBenchmark/perfpro_build{{ build.stdout }}
     mkdir -p /root/PerfProBenchmark/perfpro_build{{ build.stdout }}
     cd /root/PerfProBenchmark/perfpro_build{{ build.stdout }}/
     mkdir results
     mkdir logs
     mkdir logs/ansible
     mkdir configs
   delegate_to: "{{ item }}"
   with_items: "{{ groups['clients'] }}"

 - include: prefill.yml

 - include: s3bench.yml

 - include: cosbench.yml

 - include: hsbench.yml


#Copying ansible.log for the run to logs/ansible folder

 - name: Copying ansible log to ansible log folder
   copy:
     src: /var/log/ansible.log-{{ tstamp.stdout }}
     dest: /root/PerfProBenchmark/perfpro_build{{ build.stdout }}/logs/ansible/
   delegate_to: "{{ item }}"
   with_items: "{{ groups['clients'] }}"

#Archival of all the results and logs to NFS repository

 - name: Get timestamp from the system
   shell: "date +%F-%H-%M-%S"
   register: tstamp


 - name: Rename perfpro_build<build> directory
   shell: mv /root/PerfProBenchmark/perfpro_build{{ build.stdout }} /root/PerfProBenchmark/perfpro_build{{ build.stdout }}_{{ tstamp.stdout }}
   delegate_to: "{{ item }}"
   with_items: "{{ groups['clients'] }}"


 - name: Archiving artifacts to NFS server
   shell: |
     cd /root/PerfProBenchmark/ 
     python3 /root/PerfProBenchmark/archive_artifacts.py /root/PerfProBenchmark/config.yml perfpro_build{{ build.stdout }}_{{ tstamp.stdout }}
   delegate_to: "{{ item }}"
   with_items: "{{ groups['clients'] }}"


